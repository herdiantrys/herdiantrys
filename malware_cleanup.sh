#!/bin/bash

echo "Running Emergency Malware Cleanup..."

# 1. Matikan Persistence (Agar tidak hidup lagi)
service cron stop
systemctl stop cron

# 2. Kill Paksa Process Jahat (Berdasarkan nama umum)
echo "Killing malicious processes..."
pkill -9 -f .system
pkill -9 -f .est1
pkill -9 -f .system3d
pkill -9 -f xmr
pkill -9 -f kworkerds

# 3. Hapus File Virus
echo "Removing virus files..."
# Lepas attribute immutable jika ada (biasanya virus mengunci file)
chattr -i -a /tmp/.est1
chattr -i -a /tmp/.est1/.system3d
chattr -i -a /var/tmp/.est1

# Hapus folder virus
rm -rf /tmp/.est1
rm -rf /var/tmp/.est1
rm -rf /tmp/.system3d

# 4. Bersihkan Crontab (Jadwal otomatis virus)
echo "Cleaning crontab..."
crontab -r
rm -f /var/spool/cron/root
rm -f /var/spool/cron/crontabs/root

# 5. Hapus Service Systemd Palsu
rm -f /etc/systemd/system/malware.service
rm -f /etc/systemd/system/ds.service
systemctl daemon-reload

# 6. Block Port Mining Umum
ufw deny 3333/tcp
ufw deny 4444/tcp
ufw deny 5555/tcp
ufw deny 7777/tcp
ufw deny 9000/tcp

echo "Done. Checking CPU..."
top -b -n 1 | head -n 5
